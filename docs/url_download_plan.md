# URL リストからコンテンツをダウンロードする機能 実装方針

## 概要

- 指定されたテキストファイルから 1 行ずつ URL を読み込み、各 URL のコンテンツを順番にダウンロードする Python 機能を追加する。
- ダウンロードしたファイルは指定ディレクトリに保存する。

## 実装方針

### 1. 入力仕様

- 入力ファイル: 各行に 1 つの URL が記載されたテキストファイル（例: `urls.txt`）。
- 保存先ディレクトリ: コマンドライン引数または設定ファイルで指定。

### 2. 機能要件

- URL リストファイルを 1 行ずつ読み込む。
- 各 URL に対して HTTP リクエストを行い、コンテンツを取得。
- 取得したコンテンツをファイルとして保存。
  - ファイル名は URL やレスポンスヘッダから推定、または連番で命名。
- 失敗時はエラーログを出力し、処理を継続。
- 進捗やエラーは logging で記録。

### 3. 技術要件

- 標準ライブラリ（`httpx`のみ外部依存）を優先。
- 型ヒント・docstring を徹底。
- テスト容易性を考慮し、ダウンロード処理は関数分割。
- 例外処理・リトライ機構を実装。
- 設定値やパスは引数または`.env`/`settings.py`で管理。

### 4. 配置場所

- 実装: `src/moro/utils/` または `src/moro/services/` に新規モジュール作成。
- CLI 対応: 必要に応じて`src/moro/cli/`にエントリ追加。
- テスト: `tests/unit/`にテスト追加。
- ドキュメント: 本ファイルおよび`README.md`に概要追記。

### 5. テスト方針

- pytest でユニットテスト作成。
- モックを用いて外部通信をテスト。
- 異常系（無効 URL、タイムアウト等）もカバー。

### 6. 機能追加: 連番プレフィックス

- ダウンロードしたファイルの保存時に、ファイル名の先頭に連番のプレフィックスを追加する。
- プレフィックスは 1 から開始し、ダウンロードするファイル数に応じてゼロ埋めを行う。
  - 例: 10 個のファイルの場合は `01_`, `02_`...、100 個の場合は `001_`, `002_`...。

#### 技術要件

- プレフィックスのゼロ埋め幅は、ダウンロード対象の URL リストの行数に基づいて動的に決定する。
- ファイル名の生成ロジックを関数として分離し、テスト可能な形にする。
- 既存のダウンロード処理に影響を与えないように設計する。

#### 実装手順

1. **プレフィックス生成関数の作成**
   - 入力: ダウンロード対象の URL リストの行数、現在のインデックス。
   - 出力: ゼロ埋めされた連番プレフィックス。
2. **ファイル名生成ロジックの更新**
   - 既存のファイル名生成処理にプレフィックスを追加。
3. **テストの作成**
   - 正常系: URL リストの行数に応じたプレフィックスが正しく生成されることを確認。
   - 異常系: 空の URL リストや不正なインデックスに対する挙動を確認。

#### テスト方針

- pytest を使用。
- プレフィックス生成関数の単体テストを作成。
- ダウンロード処理全体の統合テストを更新。

### 7. 機能追加: zip 化

- 保存先ディレクトリとして「\*.zip」を渡された場合、ダウンロードしたファイルを zip 圧縮する。

#### 7. 技術要件

- 保存先パスが「.zip」で終わる場合、zip モードで動作する。
- ダウンロードファイルは一時ディレクトリに保存し、全件完了後に zip 圧縮する。
- zip 圧縮には標準ライブラリの `zipfile` を使用する（追加依存なし）。
- zip 圧縮後、一時ディレクトリは削除する。
- 進捗・エラーは logging で記録。
- 既存のディレクトリ保存機能と排他的に動作するよう分岐を設計する。
- テスト容易性のため、zip 化処理は関数として分離する。

#### 7. 実装手順

1. **保存先パスの判定処理追加**
   - 保存先が「.zip」で終わる場合は zip モードで動作するよう分岐を追加する。
2. **一時ディレクトリの利用**
   - ダウンロードファイルを一時ディレクトリに保存するロジックを追加する。
3. **zip 圧縮処理の関数化**
   - 一時ディレクトリ内のファイルを指定パスの zip ファイルにまとめる処理を関数として実装する。
4. **一時ディレクトリのクリーンアップ**
   - zip 化後に一時ディレクトリを安全に削除する処理を追加する。
5. **テスト方針の拡張**
   - zip 化モードのユニットテスト・統合テストを追加する（zip 内容の検証、エラー時の挙動確認など）。
6. **ドキュメント・CLI の更新**
   - zip 化オプションの利用方法をドキュメント・CLI ヘルプに追記する。

---

## 今後のタスク

1. モジュール構成・関数設計
2. 実装（ダウンロード・保存処理）
3. CLI/設定対応
4. テスト作成
5. ドキュメント反映
