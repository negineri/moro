# EPGStation 録画データ管理クライアント機能 - 要件定義

## 概要

EPGStation の録画データを管理するクライアント機能を実装する。対象の EPGStation は OAuth2-Proxy（Keycloak 認証）の背後にあるため、Selenium による Cookie 取得を行い、API アクセスを実現する。

## ユーザーストーリー

### コア機能

- **EPGStation クライアント機能**: 録画データの管理・操作
- **Keycloak + OAuth2-Proxy 認証対応**: Selenium ベースの自動認証
- **録画データ一覧取得**: 全ビデオファイル情報の表示
- **CLI インターフェース**: `moro epgstation list` コマンドでの操作

### 推論された追加要件

- **認証 Cookie キャッシュ**: 効率的な認証管理
- **エラーハンドリング**: 認証失敗・ネットワークエラー対応
- **設定管理**: EPGStation URL・認証設定の管理
- **ログ出力**: デバッグ・運用支援

## EARS 記法による要件定義

### 基本機能要件

```
WHEN ユーザーが `moro epgstation list` を実行する際
GIVEN Keycloak + OAuth2-Proxy 認証が完了した状態において
THEN システムは EPGStation API から録画一覧を取得する
AND 各録画の全ビデオファイル（TS・エンコード済み）をテーブル形式で表示する
```

### 認証要件

```
WHILE 認証プロセスが実行されている間
THE SYSTEM SHALL Selenium を使用してトップページから Keycloak 認証画面にリダイレクトする
AND 認証完了後に設定された全ての Cookie を取得・保存する
AND Cookie キャッシュ機能で認証効率を向上させる
```

### API アクセス要件

```
WHERE EPGStation API へのアクセスが
IS 試行された場合
THE SYSTEM SHALL 認証済み Cookie を使用して API リクエストを実行する
AND 認証エラー時は自動的に再認証を実行する
AND ネットワークエラー時は適切なリトライ処理を行う
```

### データ表示要件

```
WHEN 複数のビデオファイルが存在する場合
THE SYSTEM SHALL 各ファイルを個別の行として表示する
AND ファイル種別（TS/エンコード済み）を明確に区別する
AND ファイルサイズを適切な単位（MB/GB）で表示する
```

## セキュリティ要件（自動補完）

### 認証・セキュリティ

- **Cookie の安全な保存**: パーミッション 600 での保存
- **セッション有効性の自動検証**: 期限切れ Cookie の自動検出
- **認証失敗時の適切なエラーメッセージ**: ユーザビリティとセキュリティの両立
- **Selenium WebDriver の安全な終了処理**: リソースリークの防止

### データ保護

- **認証情報のメモリクリア**: 処理完了後の機密データ消去
- **ログ出力時の機密情報マスク**: Cookie 値等の適切なマスク処理
- **一時ファイルの安全な削除**: 認証関連一時ファイルの確実な削除

## エッジケース（自動検出）

### データ処理

- **録画データが存在しない場合**: 空の結果に対する適切な表示
- **API レスポンスの JSON パースエラー**: 不正なレスポンス形式への対応
- **大量データ取得時のページネーション**: API 制限値を超える場合の処理
- **ファイルサイズ 0 の場合**: ゼロバイトファイルの表示処理

### ネットワーク・システム

- **ネットワーク接続エラー**: タイムアウト・接続失敗への対応
- **EPGStation サーバーダウン**: サービス利用不可時の処理
- **Keycloak 認証サーバーダウン**: 認証基盤の障害対応
- **Selenium WebDriver 起動失敗**: ブラウザ環境の問題対応

### 並行処理・競合状態

- **複数プロセスでの Cookie アクセス**: ファイルロック機構の実装
- **Cookie 更新中のアクセス**: 書き込み中読み取りの排他制御
- **認証プロセス中の割り込み**: 強制終了時の適切なクリーンアップ

## パフォーマンス要件

### レスポンス時間

- **初回認証**: 30秒以内での完了（ユーザー操作時間除く）
- **Cookie キャッシュ使用時**: 5秒以内でのデータ取得
- **API レスポンス**: 10秒以内での録画一覧取得

### スループット

- **大量録画データ**: 1000件以上の録画データの効率的な処理
- **ファイルサイズ計算**: 大容量ファイル情報の高速処理
- **同時接続制限**: EPGStation への適切な接続数制御

### リソース使用量

- **メモリ使用量**: 大量データ処理時の適切なメモリ管理
- **Selenium リソース**: WebDriver の効率的な利用・解放
- **Cookie キャッシュサイズ**: 適切なキャッシュサイズ制限

## 品質要件

### 可用性

- **エラー回復**: 一時的な障害からの自動回復機能
- **フェールセーフ**: 致命的エラー時の安全な停止
- **ログ記録**: 運用・デバッグに必要な情報の記録

### 保守性

- **設定外部化**: EPGStation URL 等の設定ファイル管理
- **モジュール分離**: 認証・API アクセス・表示の責務分離
- **テスタビリティ**: 単体テスト・結合テスト可能な設計

### 拡張性

- **機能追加**: 将来的な録画管理機能追加への対応
- **他システム連携**: 他の録画システムへの応用可能性
- **設定項目拡張**: 新たな設定要件への対応

## 初期実装範囲

### Phase 1: 基本機能

1. **EPGStationConfig 実装**: URL・認証設定管理
2. **Selenium 認証機能**: Keycloak 認証フロー対応
3. **Cookie キャッシュ機能**: 認証効率化
4. **録画一覧 API**: `/api/recorded` エンドポイント対応

### Phase 2: 表示・UI

1. **テーブル表示機能**: 整理された一覧表示
2. **ファイルサイズ表示**: 適切な単位での表示
3. **エラーメッセージ**: ユーザーフレンドリーな通知
4. **CLI コマンド統合**: `moro epgstation list` 実装

### Phase 3: 品質・運用

1. **包括的エラーハンドリング**: 全エラーケース対応
2. **ログ機能**: デバッグ・運用ログ
3. **テストスイート**: 単体・結合テスト
4. **ドキュメント**: 設定・使用方法

## 受け入れ基準

### 機能要件

- [ ] `moro epgstation list` コマンドが実行可能
- [ ] Keycloak 認証が自動で完了する
- [ ] 録画データが適切にテーブル形式で表示される
- [ ] 複数のビデオファイルが全て表示される
- [ ] ファイルサイズが適切な単位で表示される

### 非機能要件

- [ ] Cookie が安全に保存・管理される
- [ ] 認証エラー時に適切なメッセージが表示される
- [ ] ネットワークエラー時に適切なリトライが実行される
- [ ] 大量データでもパフォーマンスが劣化しない
- [ ] Selenium WebDriver が適切に終了される

### 品質要件

- [ ] 全エラーケースでシステムが正常に動作する
- [ ] ログ出力で十分なデバッグ情報が得られる
- [ ] 設定変更で異なる EPGStation に対応可能
- [ ] 他の moro 機能と整合性が保たれる
- [ ] コードが moro の品質基準を満たす

## 制約条件

### 技術制約

- **Selenium 依存**: OAuth2-Proxy 認証に Selenium が必須
- **手動認証**: Keycloak 認証画面でのユーザー操作が必要
- **Cookie ベース**: 認証状態の Cookie への依存

### 運用制約

- **ブラウザ環境**: Chrome WebDriver の利用可能環境が必要
- **ネットワーク**: EPGStation・Keycloak への適切なアクセス権限
- **権限**: 録画データへの読み取り権限が必要

### 設計制約

- **moro アーキテクチャ準拠**: 既存の DI・設定管理パターンの踏襲
- **fantia モジュール類似**: 認証パターンの統一
- **CLI インターフェース**: Click ベースのコマンド設計
