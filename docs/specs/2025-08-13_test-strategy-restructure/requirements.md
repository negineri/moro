# テスト戦略再構築 - 要件定義

**プロジェクト**: moro - テストコード負債解消
**作成日**: 2025-08-13
**戦略方針**: 構造品質最優先・積極的削除許容

## 📋 プロジェクト概要

現在のテストコードは **380テスト・31ファイル** に分散し、構造的負債が深刻化している。短期的なカバレッジ低下を許容し、長期的な保守性・構造改善を最優先とした根本的再構築を実施する。

## 🎯 EARS記法による要件定義

### 主要機能要件

**WHEN** テストコードが新戦略にそぐわない場合
**GIVEN** 構造改善のメリットがカバレッジ維持を上回る際
**THEN** 該当テストを削除し、必要に応じて適切な形で再実装する
**AND** カバレッジ数値よりも構造品質を評価基準とする

**WHILE** テスト負債解消を実行する間
**THE SYSTEM SHALL** 不適切な構造のテストを積極的に削除する
**AND** 適切に設計された最小限のテストセットを維持する
**AND** 量より質を重視した持続可能な構造を構築する

**WHERE** テストの価値判断が必要な箇所
**IS** 構造的に問題があるが一定のカバレッジを提供するテストが存在する場合
**THE SYSTEM SHALL** 構造品質を優先し、削除を選択する
**AND** 真に必要な機能は適切な構造で再テストする

### 新機能追加時の要件

**WHEN** 新機能を追加する際
**GIVEN** 既存テストコードが影響を受ける場合
**THEN** 開発者は影響範囲を5分以内に特定できる
**AND** 必要な修正箇所が明確に表示される

**WHILE** テストスイートを実行する間
**THE SYSTEM SHALL** 単体テスト（5秒）、統合テスト（30秒）、E2E（2分）の段階実行を提供する
**AND** 各段階での失敗時に適切なフィードバックを提供する

## 🏗️ 構造改革要件

### 積極的削除・再構築要件

1. **大胆な削除**: 構造的に不適切なテスト（推定100-150テスト削除）
2. **質重視**: 380テスト → 200-250テストの高品質セットに集約
3. **構造優先**: Test Pyramid準拠の完全再設計
4. **保守性**: 1ファイル最大200行、明確な責務分離
5. **持続可能性**: 新規開発時の構造維持メカニズム

### 削除対象の明確化

- **複数責務混在テスト**: 統合テストの大部分（特に `test_fantia.py` 1,189行）
- **過度なMock依存**: 921回のMock使用の大幅削減
- **重複機能テスト**: 類似テストの統合・削除
- **保守困難テスト**: 300行超の巨大テストクラス
- **曖昧価値テスト**: ROIが不明確なテスト

## 📊 品質評価基準（カバレッジ率を重視しない）

### 構造品質指標

1. **責務分離度**: 1テストクラス = 1責務の厳格適用
2. **保守工数**: 新機能追加時のテスト修正工数
3. **理解容易性**: 新規開発者のオンボーディング時間
4. **変更耐性**: リファクタリング時の影響範囲

### 実行性能要件

- **単体テスト**: 5秒以内
- **統合テスト**: 30秒以内
- **E2Eテスト**: 2分以内
- **全体実行**: 5分以内

## 🔄 段階的移行戦略

### Phase A: 負債解消（即座実行）

- 巨大テストファイル分割・削除
- 重複・低価値テスト削除
- **予想結果**: 380テスト → 200テスト

### Phase B: 構造再構築（2-4週間）

- Test Pyramid準拠の新構造
- 責務分離されたテスト追加
- **予想結果**: 構造品質の大幅向上

### Phase C: 品質安定化（4-8週間）

- Contract Testing導入
- 自動品質チェック実装
- **最終目標**: 持続可能な高品質テスト基盤

## 🎖️ 成功基準

### 定量指標

- **テストファイル数**: 31ファイル → 15-20ファイル
- **平均ファイルサイズ**: 269行 → 150行以下
- **Mock使用回数**: 921回 → 300回以下
- **テスト実行時間**: 現在時間の50%短縮

### 定性指標

- 新機能追加時の影響範囲特定時間: 5分以内
- 新規開発者のテストコード理解: 2週間以内
- テスト保守工数: 60%削減
- 構造品質: Clean Code原則準拠

## 🚨 リスク許容

### 一時的品質低下の許容

- **カバレッジ低下**: 一時的な数値低下は構造改善のため許容
- **機能テスト削除**: 構造的に不適切なテストは価値に関係なく削除
- **移行期間**: 最大3ヶ月の品質向上期間を設定

### 長期的品質向上の保証

- 適切な構造による自然な品質向上
- 保守性向上による継続的改善
- 持続可能な開発プロセスの確立

---

**承認基準**: 本要件定義に基づき、構造品質最優先のテスト戦略再構築を実施する
