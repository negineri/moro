# EPGStation 責務分離 - 要件定義書

**仕様書バージョン**: 1.0
**作成日**: 2025-08-11
**対象モジュール**: `src/moro/modules/epgstation/`

## 概要

現在の `ListRecordingsUseCase` はビジネスロジックとプレゼンテーション処理が混在しており、Clean Architecture 原則に違反している。責務を適切に分離し、Table と JSON の複数出力形式に対応した拡張可能なアーキテクチャに改善する。

## 問題の現状分析

### 現在の問題点

- **単一責任原則違反**: ユースケースクラスが録画取得とテーブルフォーマット処理の2つの責任を持つ
- **Clean Architecture違反**: ユースケース層がプレゼンテーション層（文字列フォーマット）に依存
- **テスタビリティ低下**: ビジネスロジックとフォーマット処理の分離不能
- **拡張性の欠如**: 新しい出力形式追加時の既存コード修正必要

### 技術的負債

- 循環的複雑度: 8 (許容範囲内だが改善余地あり)
- メソッド行数: 35行 (目標 <20行)
- 責任数: 4つ (目標: 1つ)
- テストカバレッジ: 困難 (ロジックとフォーマットの結合)

## EARS記法による要件定義

### 基本機能要件

**WHEN** ユーザーが録画一覧表示を要求する際
**GIVEN** システムに録画データが存在する場合
**THEN** システムは録画データリストを取得する
**AND** 指定されたフォーマット（Table/JSON）で出力する

**WHEN** ユーザーが録画一覧表示を要求する際
**GIVEN** システムに録画データが存在しない場合
**THEN** システムは適切なメッセージを表示する
**AND** 指定されたフォーマットでエラーメッセージを出力する

### 出力形式要件

**WHILE** CLIコマンドが実行されている間
**THE SYSTEM SHALL** `--format` オプションでTable/JSONを選択可能にする
**AND** デフォルトはTable形式とする
**AND** 無効なフォーマット指定時は適切なエラーメッセージを表示する

**WHERE** Table形式が指定された場合
**IS** 人間が読みやすい表形式で出力される
**THE SYSTEM SHALL** 既存のテーブルレイアウトを維持する
**AND** 列幅の自動調整を行う
**AND** ヘッダー行と区切り線を含める

**WHERE** JSON形式が指定された場合
**IS** 構造化データとして出力される
**THE SYSTEM SHALL** 完全なRecordingDataオブジェクトをJSONシリアライズする
**AND** 適切なインデント（2スペース）を適用する
**AND** UTF-8エンコーディングを使用する

### アーキテクチャ要件

**WHILE** ユースケースクラスが実行されている間
**THE SYSTEM SHALL** ビジネスロジックのみに責務を限定する
**AND** プレゼンテーション処理を別レイヤーに委譲する
**AND** `List[RecordingData]` オブジェクトを返却する

**WHERE** 新しい出力形式が要求された場合
**IS** 既存コードの修正なく対応可能でなければならない
**THE SYSTEM SHALL** Strategy パターンによる拡張を提供する
**AND** 既存の動作に影響を与えない
**AND** 依存性注入による柔軟な切り替えを可能にする

### 品質・非機能要件

#### テスタビリティ要件

**THE SYSTEM SHALL** 以下のテスト可能性を提供する：

- ユースケースロジックの独立単体テスト
- フォーマット処理の独立単体テスト
- モック・スタブによる各レイヤーの分離テスト
- E2Eテストでの出力形式検証

#### パフォーマンス要件

**THE SYSTEM SHALL** 以下の性能基準を満たす：

- JSON生成オーバーヘッド < 10ms（100件の録画データ）
- メモリ使用量増加 < 20%（Strategy パターン導入時）
- 既存のTable形式のレスポンス時間非劣化
- 大量データ（1000件以上）でのメモリリーク回避

#### 保守性要件

**THE SYSTEM SHALL** 以下の保守性を確保する：

- フォーマット変更時のビジネスロジック非影響
- 新しいフォーマット追加の低コスト実現（< 50行の実装）
- 既存テストの破綻防止
- Clean Code 原則の遵守

## エッジケース・例外処理

### データ異常ケース

- **空のデータセット**: 各フォーマットで適切な「データなし」メッセージ
- **不正なデータ**: バリデーション失敗時のエラーハンドリング
- **大量データ**: メモリ効率的な処理とページネーション対応

### システム異常ケース

- **リポジトリ接続失敗**: 適切なエラーメッセージとログ出力
- **JSON シリアライゼーション失敗**: フォールバック処理
- **テーブル整形失敗**: 最小限の情報での代替表示

### 運用ケース

- **設定変更**: DI設定によるデフォルトフォーマット変更対応
- **ログ出力**: 各フォーマットでの適切なログレベル設定
- **国際化**: 将来的な多言語対応への配慮

## 受け入れ基準

### 機能的受け入れ基準

- [ ] `moro epgstation list --format table` が現在と同等のテーブル出力
- [ ] `moro epgstation list --format json` が有効なJSONを出力
- [ ] デフォルト（オプション無指定）でTable形式出力
- [ ] 無効な `--format` 指定時の適切なエラーメッセージ
- [ ] 空データセット時の各フォーマット対応メッセージ

### 技術的受け入れ基準

- [ ] `ListRecordingsUseCase.execute()` が `List[RecordingData]` を返却
- [ ] Strategy パターンによるフォーマッター実装
- [ ] ユースケースとフォーマッターの完全分離
- [ ] DI コンテナでのフォーマッター管理
- [ ] 既存のエラーハンドリング機能維持

### 品質受け入れ基準

- [ ] ユースケースのユニットテスト カバレッジ > 95%
- [ ] フォーマッターのユニットテスト カバレッジ > 90%
- [ ] E2Eテストでの両フォーマット検証
- [ ] パフォーマンステスト（100件データで < 10ms増加）
- [ ] MyPy, Ruff の全チェック通過

## 技術制約・前提条件

### 既存システム制約

- Python 3.9+ (型ヒント、dataclass使用)
- Click CLI フレームワーク利用継続
- Injector DI フレームワーク利用継続
- 既存の `RecordingData` ドメインモデル利用

### 実装制約

- 既存のCLIインターフェース互換性維持
- プロジェクト規約（100文字行長、MyPy厳格モード）遵守
- テストコードでの日本語コメント許可活用
- `TYPE_CHECKING` の injector 制約考慮

### 依存関係制約

- 新規外部ライブラリ追加最小化
- 標準ライブラリ（json, typing）の積極活用
- 既存のログ設定・エラーハンドリングパターン継承

## 成功指標

### 定量指標

- **技術的負債削減**: アーキテクチャ適合度 40% → 95%
- **テスタビリティ向上**: テストカバレッジ 困難 → 90%+
- **保守性改善**: 新フォーマット追加コスト < 50行
- **拡張性確保**: フォーマット追加時の既存コード変更 0行

### 定性指標

- **開発者体験**: ビジネスロジックとプレゼンテーション処理の明確分離
- **コード品質**: Clean Architecture 原則への完全準拠
- **将来拡張**: CSV, XML等の新フォーマット対応の基盤整備
- **チーム学習**: 責務分離パターンのプロジェクト標準化

## 想定リスク

### 技術リスク（中）

- **既存テスト影響**: フォーマット分離による既存テスト修正必要
- **パフォーマンス劣化**: オブジェクト生成オーバーヘッド
- **JSON エラー**: 特殊文字・バイナリデータのシリアライゼーション

### 実装リスク（低）

- **DI設定複雑化**: 新しいフォーマッターの依存注入設定
- **CLI オプション競合**: 既存オプションとの互換性
- **エラーメッセージ不整合**: フォーマット別エラー表示の統一性

### 運用リスク（低）

- **後方互換性**: 既存スクリプトへの影響（軽微）
- **ログ出力変更**: JSONフォーマット時のログ形式
- **設定変更**: デフォルトフォーマット変更の影響範囲
