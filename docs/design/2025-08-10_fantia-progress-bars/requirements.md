# `moro fantia posts` tqdmプログレスバー機能 - 要件定義

## 概要

`moro fantia posts`コマンド実行時にtqdmライブラリを使用したプログレスバーを表示し、ユーザーに進捗状況を視覚的にフィードバックする機能を実装する。

## EARS記法による構造化要件

### 基本進捗表示要件

**WHEN** ユーザーが`moro fantia posts`コマンドを実行する際
**GIVEN** 複数のpostが処理対象として存在する場合
**THEN** システムは全体進捗を示すtqdmプログレスバーを表示する
**AND** 各postの処理開始時にプログレスバーを更新する

### 進捗情報表示要件

**WHILE** postの処理が進行している間
**THE SYSTEM SHALL** 現在処理中のpost情報（ID、タイトル）を表示する
**AND** 処理済み/総数の進捗を表示する
**AND** 推定残り時間を表示する

### ファイルダウンロード進捗要件

**WHERE** ファイルダウンロード処理において
**IF** 複数ファイルのダウンロードが発生する場合
**THE SYSTEM SHALL** ダウンロード進捗も表示する
**AND** ネストしたプログレスバーで階層的に表示する

### エラーハンドリング要件

**WHEN** post処理中にエラーが発生した場合
**THE SYSTEM SHALL** プログレスバーのステータスをエラー表示に更新する
**AND** エラー内容を適切にログ出力する
**AND** 次のpostの処理を継続する

### キャンセル処理要件

**WHEN** ユーザーがCtrl+Cで処理をキャンセルした場合
**THE SYSTEM SHALL** プログレスバーを適切に終了する
**AND** 部分完了したダウンロードをクリーンアップする

## 機能要件詳細

### F1. メインプログレスバー

- **対象**: postsコマンドのpost処理全体
- **表示項目**: 現在のpost番号/総post数、処理中post ID、推定残り時間
- **形式**: `Processing posts: 3/10 [██████░░░░] 30% (Post: 12345) ETA: 0:02:30`

### F2. ダウンロードプログレスバー

- **対象**: 各post内のファイルダウンロード
- **表示項目**: ダウンロード済み/総ファイル数、現在のファイル名
- **形式**: `  Downloading: 5/12 [████░░░░░] 42% (image.jpg)`

### F3. 条件付き表示制御

- **単一post処理時**: プログレスバー非表示または簡易表示
- **大量post処理時**: 詳細プログレスバー表示
- **fanclub取得時**: 「Posts loading...」の初期化プログレスバー

### F4. 設定による表示制御

- **設定項目**: `fantia.show_progress` (デフォルト: true)
- **無効化時**: プログレスバー非表示、通常のログ出力のみ

## 非機能要件

### NFR1. パフォーマンス

- プログレスバー更新によるオーバーヘッドは全体処理時間の5%以下
- メモリ使用量の増加は10MB以下

### NFR2. ユーザビリティ

- プログレスバーは標準出力に表示
- 既存のログ出力との干渉を避ける
- ターミナル幅に応じた自動調整

### NFR3. 保守性

- 既存のusecaseクラス構造を維持
- プログレスバー機能は独立したコンポーネントとして実装
- 将来的な他コマンドへの展開を考慮した設計

## 制約事項

### C1. 技術制約

- tqdmライブラリの使用を必須とする
- Python 3.8+環境での動作保証
- 既存のDI（依存性注入）システムとの統合

### C2. 互換性制約

- 既存のCLI引数・オプションとの互換性を維持
- 既存のログ設定との競合回避
- テスト実行時のプログレスバー制御

### C3. 運用制約

- CI/CD環境での非対話モード対応
- パイプ処理時の適切な動作
- SSH接続等の制限されたターミナル環境での動作

## 受け入れ基準

### AC1. 基本動作

- [ ] `moro fantia posts -i 1 -i 2 -i 3`実行時にプログレスバーが表示される
- [ ] 各postの処理開始時に現在のpost情報が表示される
- [ ] 全post処理完了時にプログレスバーが正常に終了する

### AC2. エラーハンドリング

- [ ] post処理エラー時にプログレスバーが適切に更新される
- [ ] Ctrl+C中断時にプログレスバーが正常終了する
- [ ] ネットワークエラー時の適切な表示

### AC3. 設定制御

- [ ] `fantia.show_progress=false`時にプログレスバーが非表示になる
- [ ] 単一post処理時は簡易表示または非表示になる

### AC4. 統合性

- [ ] 既存のテストが全て通る
- [ ] 新機能追加後もCLIの応答性が維持される
- [ ] ログ出力とプログレスバーが適切に分離される

## 依存関係

### 外部ライブラリ

- `tqdm`: プログレスバー表示
- `click`: CLI統合（既存）
- `injector`: DI統合（既存）

### 内部モジュール

- `moro.cli.fantia`: CLIエントリーポイント
- `moro.modules.fantia.usecases`: ビジネスロジック
- `moro.modules.fantia.infrastructure`: ダウンロード処理
- `moro.config.settings`: 設定管理

## リスク分析

### 高リスク

- **ターミナル互換性**: 様々なターミナル環境でのプログレスバー表示
- **並行処理**: 既存の非同期処理との競合

### 中リスク

- **メモリリーク**: 大量post処理時のプログレスバーオブジェクト管理
- **テスト実行**: CIでのプログレスバー制御

### 低リスク

- **設定変更**: 既存設定への影響
- **ログ競合**: 標準出力への影響

## 次フェーズへの引き継ぎ事項

1. **アーキテクチャ決定**: プログレスバークラスの設計方針
2. **統合方法**: 既存usecaseへの組み込み方法
3. **テスト戦略**: プログレスバー機能のテスト方法
4. **設定拡張**: FantiaConfigへの追加項目
