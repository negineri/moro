# テスト設計書: Fantia投稿データ保存ユースケース

**作成日**: 2025-08-05
**対象機能**: `FantiaSavePostUseCase` - 投稿データの取得・ダウンロード・保存

## 概要

FantiaPostDataを元に投稿データを取得し、画像・ファイルをダウンロードしてローカルに保存するユースケースのテスト設計。

## ドメイン設計

### 集約・エンティティ

- **集約ルート**: `FantiaPostData`
- **値オブジェクト**: `FantiaURL`, `FantiaFile`, `FantiaPhotoGallery`, `FantiaText`, `FantiaProduct`

### 新規追加コンポーネント

- **ユースケース**: `FantiaSavePostUseCase`
- **リポジトリ**: `FantiaPostStorageRepository` (保存専用)
- **ドメインサービス**: `FantiaDownloadService`

### ディレクトリ構造

```
{working_dir}/downloads/fantia/{creator_id}/{post_id}_{title}_{timestamp}/
├── 0000_thumb.{ext}                    # サムネイル
├── comment.txt                         # 投稿コメント
├── {content_id}_{content_title}/       # コンテンツディレクトリ
│   ├── content.txt                     # テキストコンテンツ
│   ├── url.txt                         # プロダクトURL
│   ├── 000.{ext}                       # 画像ファイル
│   └── {filename}                      # ダウンロードファイル
└── metadata.json                       # 投稿メタデータ
```

## テスト項目

### Happy Path Tests

- [ ] **HP001**: 基本的な投稿データ保存
  - 前提: 有効なFantiaPostDataが存在
  - アクション: `execute(post_data)`実行
  - 期待結果: 正常に保存完了、ディレクトリ構造が正しく作成される

- [ ] **HP002**: サムネイル付き投稿の保存
  - 前提: サムネイルURLを含むFantiaPostData
  - アクション: 保存実行
  - 期待結果: サムネイルファイルが正しくダウンロード・保存される

- [ ] **HP003**: 写真ギャラリー付き投稿の保存
  - 前提: FantiaPhotoGalleryを含むFantiaPostData
  - アクション: 保存実行
  - 期待結果: 全写真が連番でダウンロード・保存される

- [ ] **HP004**: ファイル付き投稿の保存
  - 前提: FantiaFileを含むFantiaPostData
  - アクション: 保存実行
  - 期待結果: ファイルが元のファイル名で保存される

- [ ] **HP005**: テキストコンテンツ付き投稿の保存
  - 前提: FantiaTextを含むFantiaPostData
  - アクション: 保存実行
  - 期待結果: content.txtファイルが作成される

- [ ] **HP006**: プロダクト付き投稿の保存
  - 前提: FantiaProductを含むFantiaPostData
  - アクション: 保存実行
  - 期待結果: content.txtとurl.txtが作成される

### Error Cases

- [ ] **EC001**: ダウンロード失敗時の全体ロールバック
  - 前提: 一部URLが404エラーを返す
  - アクション: 保存実行
  - 期待結果: post全体の保存が失敗、一部保存されたファイルもクリーンアップ

- [ ] **EC002**: ネットワークエラー時の処理
  - 前提: ネットワーク接続エラー
  - アクション: 保存実行
  - 期待結果: 適切なエラーメッセージと例外発生

- [ ] **EC003**: ディスク容量不足時の処理
  - 前提: 保存先ディスクに十分な容量がない
  - アクション: 保存実行
  - 期待結果: IOErrorが発生、部分的保存データのクリーンアップ

- [ ] **EC004**: 権限不足時の処理
  - 前提: 保存先ディレクトリへの書き込み権限がない
  - アクション: 保存実行
    • 期待結果: PermissionErrorが発生

### Edge Cases

- [ ] **ED001**: 空のコンテンツリストを持つ投稿
  - 前提: contents\_\*が全て空リストのFantiaPostData
  - アクション: 保存実行
  - 期待結果: メタデータのみ保存される

- [ ] **ED002**: 非常に長いファイル名の処理
  - 前提: タイトルが255文字を超える投稿データ
  - アクション: 保存実行
  - 期待結果: ファイル名がサニタイズされ、適切な長さに切り詰められる

- [ ] **ED003**: 特殊文字を含むファイル名の処理
  - 前提: タイトルに/<>:"\|?\*を含む投稿データ
  - アクション: 保存実行
  - 期待結果: 特殊文字が適切にサニタイズされる

- [ ] **ED004**: 既存ディレクトリが存在する場合
  - 前提: 同一の投稿IDで既にディレクトリが存在
  - アクション: 保存実行
  - 期待結果: 既存ディレクトリは上書きされる

### Integration Tests

- [ ] **IT001**: UseCaseレイヤーから実際のファイル保存までの統合
  - 前提: 実際のFantiaPostDataとファイルシステム
  - アクション: ユースケース実行
  - 期待結果: end-to-endで正常に保存される

- [ ] **IT002**: DIコンテナとの統合
  - 前提: Injectorによる依存性注入設定
  - アクション: ユースケースインスタンス取得・実行
  - 期待結果: 全依存関係が正しく注入され動作する

## 実装指針

### 原子性の担保

- すべてのダウンロード処理が成功した場合のみ保存を確定
- 途中で失敗した場合は部分的に作成されたファイル・ディレクトリを削除

### エラーハンドリング

- ダウンロード失敗時は具体的なエラー内容をログ出力
- リソースのクリーンアップを確実に実行

### 型安全性

- モダンなPython型ヒント使用 (`list[T]` 形式)
- Union型でNoneチェックを明示的に処理
- 必要に応じてisinstanceによる型ガード使用
